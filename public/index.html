<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>3人チーム 成績表（その場限り）</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div id="app" class="wrap">
  <h1 class="page-title">rec3on3.web.app</h1>
  <div class="title-display" @click="openTitleModal">
    <span v-if="pageTitle">{{ pageTitle }}</span>
    <span v-else style="color:#888;">タイトルを入力</span>
    <span class="edit-icon">✏️</span>
  </div>
  <table>
    <thead>
      <tr>
        <th v-for="(p,i) in players" :key="i" @click="openPlayerModal(i)" class="player-header">
          <div class="player-name">{{ getPlayerName(p, i) }}</div>
          <div class="player-char">
            <span v-for="colorKey in p.colors" :key="colorKey" class="color-dot" :style="{backgroundColor: getColorCode(colorKey)}"></span>
            {{ p.char }}
          </div>
        </th>
        <th class="team-header"></th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="(row, rIdx) in matchups" :key="row.id">
        <td v-for="(cell, cIdx) in row.cells" :key="cIdx" class="cell" @click="openModal(rIdx,cIdx)">
          <template v-if="cellFilled(cell)">
            <div v-html="formatCell(cell)"></div>
          </template>
          <template v-else>
            <div style="color:#888;">タップして<br>入力</div>
          </template>
        </td>
        <td class="cell team" @click="openDeleteModal(rIdx)">
          <div :class="teamClass(teamOutcome(row))">{{ teamMark(teamOutcome(row)) }}</div>
        </td>
      </tr>
    </tbody>
  </table>
  <div style="text-align:center;margin-top:16px;">
    <button class="btn" @click="addMatchup">＋ マッチアップを追加</button>
  </div>

  <!-- モーダル: セル編集 -->
  <div class="modal-backdrop" :class="{show: modal.open}">
    <div class="modal">
      <div class="modal-head">
        <div v-if="modal.playerIdx !== null">{{ getPlayerName(players[modal.playerIdx], modal.playerIdx) }} - {{ modal.rIdx + 1 }}戦目</div>
      </div>
      <div class="field">
        <div class="colors">
          <label v-for="c in colorOptions" :key="'opp-'+c.key" class="color-box">
            <input type="checkbox" :value="c.key" v-model="modal.buf.oppColors">
            <span class="color-square" :style="{backgroundColor: c.color}"></span>
          </label>
        </div>
      </div>
      <div class="field">
        <input class="input" v-model="modal.buf.oppChar" placeholder="キャラクター名">
      </div>
      <div class="field">
        <div class="radios">
          <label class="radio">
            <input type="radio" value="先行" v-model="modal.buf.order">
            <span>先</span>
          </label>
          <label class="radio">
            <input type="radio" value="後攻" v-model="modal.buf.order">
            <span>後</span>
          </label>
          <label class="radio">
            <input type="radio" value="勝ち" v-model="modal.buf.result">
            <span>⭕️</span>
          </label>
          <label class="radio">
            <input type="radio" value="負け" v-model="modal.buf.result">
            <span>❌️</span>
          </label>
        </div>
      </div>
      <div style="margin-top:12px;text-align:center;">
        <button class="btn" @click="applyModal">反映</button>
      </div>
    </div>
  </div>

  <!-- モーダル: プレイヤー名編集 -->
  <div class="modal-backdrop" :class="{show: playerModal.open}">
    <div class="modal">
      <div class="modal-head">
        <div>プレイヤー情報を編集</div>
        <button class="btn secondary" @click="closePlayerModal">閉じる</button>
      </div>
      <div class="field">
        <input class="input" v-model="playerModal.name" placeholder="プレイヤー名">
      </div>
      <div class="field">
        <div class="colors">
          <label v-for="c in colorOptions" :key="'player-'+c.key" class="color-box">
            <input type="checkbox" :value="c.key" v-model="playerModal.colors">
            <span class="color-square" :style="{backgroundColor: c.color}"></span>
          </label>
        </div>
      </div>
      <div class="field">
        <input class="input" v-model="playerModal.char" placeholder="キャラクター名">
      </div>
      <div style="margin-top:12px;text-align:center;">
        <button class="btn" @click="applyPlayerName">反映</button>
      </div>
    </div>
  </div>

  <!-- モーダル: マッチアップ削除 -->
  <div class="modal-backdrop" :class="{show: deleteModal.open}">
    <div class="modal">
      <div class="modal-head">
        <div>マッチアップを削除</div>
        <button class="btn secondary" @click="closeDeleteModal">キャンセル</button>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-weight:600; margin-bottom:8px;">{{ deleteModal.index + 1 }}回目のマッチ</div>
        <div style="font-size:0.9rem; color:#666;">
          <div v-for="(cell, idx) in deleteModal.cells" :key="idx" style="margin-bottom:4px;">
            {{ getPlayerName(players[idx], idx) }}: {{ formatDeleteCell(cell) }}
          </div>
        </div>
      </div>
      <div style="text-align:center;">
        <button class="btn secondary" @click="closeDeleteModal">キャンセル</button>
        <button class="btn" style="background:#e05555;margin-left:12px;" @click="confirmDelete">削除</button>
      </div>
    </div>
  </div>

  <!-- モーダル: タイトル編集 -->
  <div class="modal-backdrop" :class="{show: titleModal.open}">
    <div class="modal">
      <div class="modal-head">
        <div>タイトルを編集</div>
        <button class="btn secondary" @click="closeTitleModal">閉じる</button>
      </div>
      <div class="field">
        <input class="input" v-model="titleModal.text" placeholder="タイトルを入力">
      </div>
      <div style="margin-top:12px;text-align:center;">
        <button class="btn" @click="applyTitle">反映</button>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;
createApp({
  data(){
    return {
      pageTitle:'',
      players:[
        {name:'',char:'',colors:[]},
        {name:'',char:'',colors:[]},
        {name:'',char:'',colors:[]}
      ],
      matchups:[makeEmptyRow()],
      modal:{open:false,rIdx:null,cIdx:null,playerIdx:null,buf:{oppChar:'',oppColors:[],order:'',result:''}},
      playerModal:{open:false,index:null,name:'',char:'',colors:[]},
      deleteModal:{open:false,index:null,cells:[]},
      titleModal:{open:false,text:''},
      colorOptions:[
        {key:'red',color:'#dc3545'},
        {key:'blue',color:'#0d6efd'},
        {key:'green',color:'#198754'},
        {key:'purple',color:'#6f42c1'},
        {key:'black',color:'#212529'},
        {key:'yellow',color:'#ffc107'}
      ]
    }
  },
  methods:{
    getPlayerName(player, index){
      return player.name || `Player${index + 1}`;
    },
    getColorCode(key){
      const color = this.colorOptions.find(c => c.key === key);
      return color ? color.color : '#ccc';
    },
    addMatchup(){this.matchups.push(makeEmptyRow());},
    cellFilled(c){return c.oppChar||c.order||c.result;},
    teamOutcome(row){const res=row.cells.map(c=>c.result);const w=res.filter(x=>x==='勝ち').length;const l=res.filter(x=>x==='負け').length;if(w>=2)return{type:'win'};if(l>=2)return{type:'lose'};return{type:'draw'};},
    teamClass(o){return{win:o.type==='win',lose:o.type==='lose',draw:o.type==='draw'};},
    teamMark(o){return o.type==='win'?'◎':o.type==='lose'?'×':'△';},
    formatCell(cell){
      const resultSymbol = cell.result==='勝ち'?'⭕️':cell.result==='負け'?'❌️':'';
      const colorDots = cell.oppColors.map(key => `<span class="color-dot" style="background-color:${this.getColorCode(key)}"></span>`).join('');
      const charInfo = [colorDots, cell.oppChar].filter(Boolean).join('');
      const resultInfo = [cell.order, resultSymbol].filter(Boolean).join(' ');
      return [charInfo, resultInfo].filter(Boolean).join('<br>');
    },
    openModal(r,c){
      this.modal.open=true;
      this.modal.rIdx=r;
      this.modal.cIdx=c;
      this.modal.playerIdx=c;
      const currentCell = this.matchups[r].cells[c];
      this.modal.buf=JSON.parse(JSON.stringify(currentCell));
    },
    closeModal(){this.modal.open=false;},
    applyModal(){this.matchups[this.modal.rIdx].cells[this.modal.cIdx]=JSON.parse(JSON.stringify(this.modal.buf));this.closeModal();},
    clearCell(){
      if(!confirm('この対戦記録をクリアしますか？'))return;
      this.matchups[this.modal.rIdx].cells[this.modal.cIdx]={oppChar:'',oppColors:[],order:'',result:''};
      this.closeModal();
    },
    openPlayerModal(i){
      this.playerModal.open=true;
      this.playerModal.index=i;
      const player=this.players[i];
      this.playerModal.name=player.name;
      this.playerModal.char=player.char;
      this.playerModal.colors=JSON.parse(JSON.stringify(player.colors));
    },
    closePlayerModal(){this.playerModal.open=false;},
    applyPlayerName(){
      const player=this.players[this.playerModal.index];
      player.name=this.playerModal.name;
      player.char=this.playerModal.char;
      player.colors=JSON.parse(JSON.stringify(this.playerModal.colors));
      this.closePlayerModal();
    },
    openDeleteModal(idx){
      this.deleteModal.open=true;
      this.deleteModal.index=idx;
      this.deleteModal.cells=this.matchups[idx].cells;
    },
    closeDeleteModal(){
      this.deleteModal.open=false;
    },
    confirmDelete(){
      if(!confirm('3人の対戦記録を削除しますか？'))return;
      this.matchups.splice(this.deleteModal.index,1);
      if(this.matchups.length===0)this.matchups.push(makeEmptyRow());
      this.closeDeleteModal();
    },
    formatDeleteCell(cell){
      if(!this.cellFilled(cell))return '未入力';
      const resultSymbol=cell.result==='勝ち'?'⭕️':cell.result==='負け'?'❌️':'';
      const colorNames = cell.oppColors.map(key => key).join(',');
      return `${colorNames}${cell.oppChar} ${cell.order}${resultSymbol}`;
    },
    openTitleModal(){
      this.titleModal.open=true;
      this.titleModal.text=this.pageTitle;
    },
    closeTitleModal(){this.titleModal.open=false;},
    applyTitle(){
      this.pageTitle=this.titleModal.text;
      this.closeTitleModal();
    }
  }
}).mount('#app');
function makeEmptyRow(){return{id:Math.random().toString(36).slice(2),cells:[{oppChar:'',oppColors:[],order:'',result:''},{oppChar:'',oppColors:[],order:'',result:''},{oppChar:'',oppColors:[],order:'',result:''}]};}
</script>
</body>
</html>
